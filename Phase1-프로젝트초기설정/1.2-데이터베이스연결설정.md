# 1.2 데이터베이스 연결 설정

## 개요
DB2 운영/개발/테스트 데이터베이스 연결 설정을 구성하는 단계입니다.

## 작업 체크리스트

### DB2 드라이버 설정
- [ ] build.gradle에 DB2 드라이버 의존성 확인
```gradle
implementation 'com.ibm.db2:jcc:11.5.8.0'
```

- [ ] DB2 드라이버 다운로드 및 설치 확인
- [ ] 라이센스 확인 및 적용

### 운영/개발/테스트 DB 연결 정보 설정

#### application-dev.yml 생성
- [ ] src/main/resources/application-dev.yml 파일 생성
```yaml
spring:
  datasource:
    primary:
      driver-class-name: com.ibm.db2.jcc.DB2Driver
      url: jdbc:db2://dev-db-server:50000/DEVDB
      username: ${DB_DEV_USERNAME:dev_user}
      password: ${DB_DEV_PASSWORD:dev_password}
      hikari:
        maximum-pool-size: 10
        minimum-idle: 2
        idle-timeout: 300000
        connection-timeout: 30000
        validation-timeout: 5000
        leak-detection-threshold: 60000

    secondary:
      driver-class-name: com.ibm.db2.jcc.DB2Driver
      url: jdbc:db2://test-db-server:50000/TESTDB
      username: ${DB_TEST_USERNAME:test_user}
      password: ${DB_TEST_PASSWORD:test_password}
      hikari:
        maximum-pool-size: 5
        minimum-idle: 1
        idle-timeout: 300000
        connection-timeout: 30000

    source:
      driver-class-name: com.ibm.db2.jcc.DB2Driver
      url: jdbc:db2://prod-db-server:50000/PRODDB
      username: ${DB_PROD_USERNAME:prod_user}
      password: ${DB_PROD_PASSWORD:prod_password}
      hikari:
        maximum-pool-size: 15
        minimum-idle: 3
        idle-timeout: 300000
        connection-timeout: 30000
        read-only: true

  jpa:
    database: DB2
    show-sql: true
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.DB2Dialect
        format_sql: true
        use_sql_comments: true

  batch:
    job:
      enabled: false
    jdbc:
      initialize-schema: always
```

#### application-prod.yml 생성
- [ ] src/main/resources/application-prod.yml 파일 생성
```yaml
spring:
  datasource:
    primary:
      driver-class-name: com.ibm.db2.jcc.DB2Driver
      url: jdbc:db2://${DB_PRIMARY_HOST}:${DB_PRIMARY_PORT:50000}/${DB_PRIMARY_NAME}
      username: ${DB_PRIMARY_USERNAME}
      password: ${DB_PRIMARY_PASSWORD}
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5
        idle-timeout: 600000
        connection-timeout: 30000
        validation-timeout: 5000
        leak-detection-threshold: 60000

    secondary:
      driver-class-name: com.ibm.db2.jcc.DB2Driver
      url: jdbc:db2://${DB_SECONDARY_HOST}:${DB_SECONDARY_PORT:50000}/${DB_SECONDARY_NAME}
      username: ${DB_SECONDARY_USERNAME}
      password: ${DB_SECONDARY_PASSWORD}
      hikari:
        maximum-pool-size: 10
        minimum-idle: 2
        idle-timeout: 600000
        connection-timeout: 30000

    source:
      driver-class-name: com.ibm.db2.jcc.DB2Driver
      url: jdbc:db2://${DB_SOURCE_HOST}:${DB_SOURCE_PORT:50000}/${DB_SOURCE_NAME}
      username: ${DB_SOURCE_USERNAME}
      password: ${DB_SOURCE_PASSWORD}
      hikari:
        maximum-pool-size: 25
        minimum-idle: 5
        idle-timeout: 600000
        connection-timeout: 30000
        read-only: true

  jpa:
    database: DB2
    show-sql: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.DB2Dialect

  batch:
    job:
      enabled: true
    jdbc:
      initialize-schema: never

logging:
  level:
    com.sbs.datasync: INFO
    org.springframework.batch: WARN
```

### 데이터소스 멀티 설정 (운영용/대상용)

#### DatabaseConfig.java 생성
- [ ] src/main/java/com/sbs/datasync/config/DatabaseConfig.java 파일 생성
```java
package com.sbs.datasync.config;

import com.zaxxer.hikari.HikariDataSource;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;
import java.util.Properties;

@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(
    basePackages = "com.sbs.datasync.repository",
    entityManagerFactoryRef = "primaryEntityManagerFactory",
    transactionManagerRef = "primaryTransactionManager"
)
public class DatabaseConfig {

    @Primary
    @Bean(name = "primaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create()
                .type(HikariDataSource.class)
                .build();
    }

    @Bean(name = "secondaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create()
                .type(HikariDataSource.class)
                .build();
    }

    @Bean(name = "sourceDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.source")
    public DataSource sourceDataSource() {
        return DataSourceBuilder.create()
                .type(HikariDataSource.class)
                .build();
    }

    @Primary
    @Bean(name = "primaryEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean primaryEntityManagerFactory() {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(primaryDataSource());
        em.setPackagesToScan("com.sbs.datasync.entity");

        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        em.setJpaVendorAdapter(vendorAdapter);

        Properties properties = new Properties();
        properties.setProperty("hibernate.dialect", "org.hibernate.dialect.DB2Dialect");
        properties.setProperty("hibernate.hbm2ddl.auto", "validate");
        properties.setProperty("hibernate.show_sql", "false");
        em.setJpaProperties(properties);

        return em;
    }

    @Primary
    @Bean(name = "primaryTransactionManager")
    public PlatformTransactionManager primaryTransactionManager() {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(
            primaryEntityManagerFactory().getObject()
        );
        return transactionManager;
    }
}
```

#### DataSourceType.java 생성
- [ ] src/main/java/com/sbs/datasync/config/DataSourceType.java 파일 생성
```java
package com.sbs.datasync.config;

public enum DataSourceType {
    PRIMARY("primaryDataSource", "주 데이터베이스"),
    SECONDARY("secondaryDataSource", "보조 데이터베이스"),
    SOURCE("sourceDataSource", "원본 데이터베이스");

    private final String beanName;
    private final String description;

    DataSourceType(String beanName, String description) {
        this.beanName = beanName;
        this.description = description;
    }

    public String getBeanName() {
        return beanName;
    }

    public String getDescription() {
        return description;
    }
}
```

### 기본 연결 테스트

#### DatabaseConnectionTest.java 생성
- [ ] src/test/java/com/sbs/datasync/config/DatabaseConnectionTest.java 파일 생성
```java
package com.sbs.datasync.config;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.SQLException;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
@ActiveProfiles("dev")
class DatabaseConnectionTest {

    @Autowired
    @Qualifier("primaryDataSource")
    private DataSource primaryDataSource;

    @Autowired
    @Qualifier("secondaryDataSource")
    private DataSource secondaryDataSource;

    @Autowired
    @Qualifier("sourceDataSource")
    private DataSource sourceDataSource;

    @Test
    void testPrimaryDataSourceConnection() {
        assertDoesNotThrow(() -> {
            try (Connection connection = primaryDataSource.getConnection()) {
                assertNotNull(connection);
                assertFalse(connection.isClosed());
                System.out.println("Primary DataSource 연결 성공");
            }
        });
    }

    @Test
    void testSecondaryDataSourceConnection() {
        assertDoesNotThrow(() -> {
            try (Connection connection = secondaryDataSource.getConnection()) {
                assertNotNull(connection);
                assertFalse(connection.isClosed());
                System.out.println("Secondary DataSource 연결 성공");
            }
        });
    }

    @Test
    void testSourceDataSourceConnection() {
        assertDoesNotThrow(() -> {
            try (Connection connection = sourceDataSource.getConnection()) {
                assertNotNull(connection);
                assertFalse(connection.isClosed());
                System.out.println("Source DataSource 연결 성공");
            }
        });
    }

    @Test
    void testAllDataSourcesMetadata() throws SQLException {
        // Primary DataSource 메타데이터 확인
        try (Connection conn = primaryDataSource.getConnection()) {
            String url = conn.getMetaData().getURL();
            String userName = conn.getMetaData().getUserName();
            String driverName = conn.getMetaData().getDriverName();

            System.out.println("Primary DB URL: " + url);
            System.out.println("Primary DB User: " + userName);
            System.out.println("Primary DB Driver: " + driverName);
        }

        // Source DataSource 메타데이터 확인
        try (Connection conn = sourceDataSource.getConnection()) {
            String url = conn.getMetaData().getURL();
            String userName = conn.getMetaData().getUserName();

            System.out.println("Source DB URL: " + url);
            System.out.println("Source DB User: " + userName);
        }
    }
}
```

#### HealthCheckController.java 생성
- [ ] src/main/java/com/sbs/datasync/controller/HealthCheckController.java 파일 생성
```java
package com.sbs.datasync.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.sql.DataSource;
import java.sql.Connection;
import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/health")
public class HealthCheckController {

    @Autowired
    @Qualifier("primaryDataSource")
    private DataSource primaryDataSource;

    @Autowired
    @Qualifier("secondaryDataSource")
    private DataSource secondaryDataSource;

    @Autowired
    @Qualifier("sourceDataSource")
    private DataSource sourceDataSource;

    @GetMapping("/database")
    public ResponseEntity<Map<String, Object>> checkDatabaseConnection() {
        Map<String, Object> result = new HashMap<>();

        try {
            // Primary Database 연결 확인
            try (Connection conn = primaryDataSource.getConnection()) {
                result.put("primary", Map.of(
                    "status", "UP",
                    "url", conn.getMetaData().getURL(),
                    "user", conn.getMetaData().getUserName()
                ));
            }

            // Secondary Database 연결 확인
            try (Connection conn = secondaryDataSource.getConnection()) {
                result.put("secondary", Map.of(
                    "status", "UP",
                    "url", conn.getMetaData().getURL(),
                    "user", conn.getMetaData().getUserName()
                ));
            }

            // Source Database 연결 확인
            try (Connection conn = sourceDataSource.getConnection()) {
                result.put("source", Map.of(
                    "status", "UP",
                    "url", conn.getMetaData().getURL(),
                    "user", conn.getMetaData().getUserName()
                ));
            }

            result.put("overall", "UP");
            return ResponseEntity.ok(result);

        } catch (Exception e) {
            result.put("overall", "DOWN");
            result.put("error", e.getMessage());
            return ResponseEntity.status(503).body(result);
        }
    }
}
```

### 환경 변수 설정

#### .env.example 생성
- [ ] 프로젝트 루트에 .env.example 파일 생성
```bash
# Development Database
DB_DEV_USERNAME=dev_user
DB_DEV_PASSWORD=dev_password

# Test Database
DB_TEST_USERNAME=test_user
DB_TEST_PASSWORD=test_password

# Production Source Database (Read-Only)
DB_PROD_USERNAME=prod_readonly_user
DB_PROD_PASSWORD=prod_readonly_password

# Production Primary Database
DB_PRIMARY_HOST=prod-primary-db.company.com
DB_PRIMARY_PORT=50000
DB_PRIMARY_NAME=PRIMARYDB
DB_PRIMARY_USERNAME=primary_user
DB_PRIMARY_PASSWORD=primary_password

# Production Secondary Database
DB_SECONDARY_HOST=prod-secondary-db.company.com
DB_SECONDARY_PORT=50000
DB_SECONDARY_NAME=SECONDARYDB
DB_SECONDARY_USERNAME=secondary_user
DB_SECONDARY_PASSWORD=secondary_password

# Production Source Database
DB_SOURCE_HOST=prod-source-db.company.com
DB_SOURCE_PORT=50000
DB_SOURCE_NAME=SOURCEDB
DB_SOURCE_USERNAME=source_readonly_user
DB_SOURCE_PASSWORD=source_readonly_password
```

### 테스트용 H2 데이터베이스 설정

#### application-test.yml 생성
- [ ] src/test/resources/application-test.yml 파일 생성
```yaml
spring:
  datasource:
    primary:
      driver-class-name: org.h2.Driver
      url: jdbc:h2:mem:testdb_primary;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
      username: sa
      password:

    secondary:
      driver-class-name: org.h2.Driver
      url: jdbc:h2:mem:testdb_secondary;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
      username: sa
      password:

    source:
      driver-class-name: org.h2.Driver
      url: jdbc:h2:mem:testdb_source;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
      username: sa
      password:

  jpa:
    database: H2
    hibernate:
      ddl-auto: create-drop
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect

  h2:
    console:
      enabled: true

  batch:
    job:
      enabled: false
    jdbc:
      initialize-schema: always
```

## 완료 확인 방법

### 데이터베이스 연결 테스트
- [ ] 단위 테스트 실행 성공
```bash
./gradlew test --tests DatabaseConnectionTest
```

### Health Check API 테스트
- [ ] 애플리케이션 실행 후 Health Check API 호출
```bash
curl http://localhost:8080/api/health/database
```

### 로그 확인
- [ ] 애플리케이션 시작 시 데이터베이스 연결 로그 확인
- [ ] HikariCP 커넥션 풀 초기화 로그 확인

### 설정 파일 검증
- [ ] 모든 환경별 설정 파일이 올바르게 생성되었는지 확인
- [ ] 환경 변수 치환이 올바르게 동작하는지 확인

## 주의 사항
- DB2 드라이버 라이센스 확인 필수
- 운영 데이터베이스 접근 권한 최소화
- 패스워드는 반드시 환경 변수로 관리
- 커넥션 풀 설정은 실제 사용량에 맞게 조정

## 다음 단계
1.3 기본 엔티티 및 테이블 설계로 진행